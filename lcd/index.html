<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Moosic LCD Screen</title>

    <link href="https://fonts.googleapis.com/css2?family=Rubik+Mono+One&family=Rubik:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
      /* reset.css */
      html, body, div, span, applet, object, iframe,
      h1, h2, h3, h4, h5, h6, p, blockquote, pre,
      a, abbr, acronym, address, big, cite, code,
      del, dfn, em, img, ins, kbd, q, s, samp,
      small, strike, strong, sub, sup, tt, var,
      b, u, i, center,
      dl, dt, dd, ol, ul, li,
      fieldset, form, label, legend,
      table, caption, tbody, tfoot, thead, tr, th, td,
      article, aside, canvas, details, embed, 
      figure, figcaption, footer, header, hgroup, 
      menu, nav, output, ruby, section, summary,
      time, mark, audio, video {
        margin: 0;
        padding: 0;
        border: 0;
        font-size: 100%;
        font: inherit;
        vertical-align: baseline;
      }
      /* HTML5 display-role reset for older browsers */
      article, aside, details, figcaption, figure, 
      footer, header, hgroup, menu, nav, section {
        display: block;
      }
      body {
        line-height: 1;
      }
      ol, ul {
        list-style: none;
      }
      blockquote, q {
        quotes: none;
      }
      blockquote:before, blockquote:after,
      q:before, q:after {
        content: '';
        content: none;
      }
      table {
        border-collapse: collapse;
        border-spacing: 0;
      }
      /* end of reset */

      #albumart {
        background: #444;
        border-radius: 4%;
      }
      #quality {
        padding: 10px;
        background-color: rgb(255,255,255);
        border-radius: 6px;
        font-weight: 600;
        display: inline;
      }

      progress {
        -webkit-appearance: none;
        appearance: none;
      }
      progress::-webkit-progress-bar {
        border-radius: 1000px;
        overflow: hidden;
      }

      @media screen and (width: 480px) and (height: 320px) {
        body {
          color: #4A5A67!important;
          background-color: #255C99!important;
        }
        body:after {
          content: '';
          position: absolute;
          top: 144px;
          left: 0;
          height: 130px;
          width: 100vw;
          background-color: #faffff;
          z-index: -1;
        }
        #albumart {
          position: absolute;
          top: 11px;
          left: 179px;
          height: 122px;
          border-radius: 0;
        }
        #title {
          width: 100%;
          text-align: center;
          font-weight: 600;
          font-size: 18px;
          margin-top: 158px;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
        }
        #artist {
          width: 100%;
          text-align: center;
          font-weight: 600;
          font-size: 15px;
          margin-top: 6px;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
        }
        #album {
          width: 100%;
          text-align: center;
          font-weight: 400;
          font-size: 15px;
          margin-top: 6px;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
        }
        #quality {
          font-size: 12px;
          padding: 6px 8px 7px 8px;
          background-color: #255C99;
          border-radius: 6px;
          font-weight: 600;
          margin-left: auto;
          margin-right: auto;
          color: #faffff!important;
          display: table;
          margin-top: 11px;
        }
        #state-play {
          display: none;
        }
        #state-pause {
          position: absolute;
          left: calc(50vw - 16px);
          height: 32px;
          width: 32px;
          top: 60px;
          stroke: #faffff;
        }
        #queue {
          display: none;
        }
        progress {
          width: 90vw;
          height: 13px;
          position: absolute;
          top: 290px;
          left: 5vw;
        }
        progress::-webkit-progress-bar {
          background-color: rgba(255,255,255,0.2);
        }
        progress::-webkit-progress-value {
          background-color: rgb(255,255,255);
        }
        #elapsed {
          position: absolute;
          bottom: 55px;
          left: 5vw;
        }
        #duration {
          position: absolute;
          bottom: 55px;
          right: 5vw;
        }
        #queue-pos {
          display: none;
        }
      }

      @media screen and (width: 1920px)  and (height: 480px) {
        #albumart {
          height: 420px;
          width: 420px;
          position: absolute;
          top: 30px;
          left: 30px;
          box-shadow: 0px 0px 7px 0px rgba(0,0,0,0.33);
        }
        #title {
          font-size: 50px;
          position: absolute;
          top: 50px;
          left: 503px;
          font-weight: 700;
          max-width: 875px;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
        }
        #artist {
          font-size: 37px;
          position: absolute;
          top: 115px;
          left: 503px;
          font-weight: 600;
          max-width: 875px;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
        }
        #album {
          font-size: 35px;
          position: absolute;
          top: 170px;
          left: 503px;
          max-width: 875px;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
        }
        #quality {
          font-size: 22px;
          position: absolute;
          top: 232px;
          left: 503px;
        }
        body.light #quality {
          background-color: rgba(0,0,0,0.6);
        }
        #state-play, #state-pause {
          position: absolute;
          left: 940px;
          top: 350px;
          height: 48px;
          width: 48px;
        }
        #elapsed {
          font-size: 28px;
          position: absolute;
          top: 366px;
          left: 503px;
        }
        #duration {
          font-size: 28px;
          position: absolute;
          top: 366px;
          right: 542px;
        }
        progress {
          width: 875px;
          height: 27px;
          position: absolute;
          top: 413px;
          left: 503px;
        }
        progress::-webkit-progress-bar {
          background-color: rgba(255,255,255,0.2);
          border-radius: 1000px;
          overflow: hidden;
        }
        body.light progress::-webkit-progress-bar {
          background-color: rgba(0,0,0,0.2);
        }
        progress::-webkit-progress-value {
          background-color: rgb(255,255,255);
        }
        body.light progress::-webkit-progress-value {
          background-color: rgba(0,0,0,0.45);
        }
        #queue {
          position: absolute;
          top: 0px;
          left: 1436;
          width: 483px;
          height: 480px;
          background: rgba(255,255,255,0.12);
        }
        body.light #queue {
          background: rgba(0,0,0,0.06);
        }
        #queue li {
          position: relative;
          padding: 23px 10px 27px 25px;
          font-size: 30px;
        }
        #queue li span {
          max-width: 420px;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
        }
        #queue li.active {
          background: rgba(255,255,255,0.1);
        }
        body.light #queue li.active {
          background: rgba(0,0,0,0.1);
        }
        #queue li .title {
          font-weight: bold;
          display: block;
        }
        #queue-pos {
          display: none;
        }
      }
      @media screen and (width: 800px) and (height: 480px) {
        #albumart {
          height: 250px;
          box-shadow: 0px 0px 7px 0px rgba(0,0,0,0.33);
          margin: 40px;
        }
        #title, #artist, #album, #quality {
          position: absolute;
          left: 330px;
          max-width: 430px;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
        }
        #title {
          top: 90px;
          font-size: 30px;
          font-weight: 700;
        }
        #artist {
          top: 130px;
          font-size: 23px;
          font-weight: 500;
        }
        #album {
          top: 160px;
          font-size: 20px;
        }
        #quality {
          top: 205px;
          font-size: 17px;
          padding: 7px 9px;
        }
        #progress {
          position: absolute;
          left: 40px;
          width: 720px;
          top: 423px;
        }
        #elapsed {
          position: absolute;
          left: 40px;
          top: 394px;
          font-size: 18px;
        }
        #duration {
          position: absolute;
          right: 40px;
          top: 394px;
          font-size: 18px;
        }
        #state-play, #state-pause {
          height: 48px;
          width: 48px;
          position: absolute;
          left: calc(50vw - 24px);
          top: 330px;
        }
        progress::-webkit-progress-bar {
          background-color: rgba(255,255,255,0.2);
          border-radius: 1000px;
          overflow: hidden;
        }
        body.light progress::-webkit-progress-bar {
          background-color: rgba(0,0,0,0.2);
        }
        progress::-webkit-progress-value {
          background-color: rgb(255,255,255);
        }
        body.light progress::-webkit-progress-value {
          background-color: rgba(0,0,0,0.45);
        }
        #queue {
          display: none;
        }
        #queue-pos {
          position: absolute;
          width: 100%;
          top: 446px;
          left: 0;
          text-align: center;
          font-weight: 500;
        }
      }
      #not-playing {
        position: absolute;
        top: 0;
        left: 0;
        height: 100%;
        width: 100%;
        background: #255C99;
        transition: left 0.5s ease;
      }
      #not-playing img {
        position: absolute;
        height: 60vh;
        top: calc(50% - (60vh / 2));
        left: calc(50% - (60vh / 2));
        border-radius: 7%;
      }
      #not-playing.hide {
        left: calc(0px - 100vw);
        transition: left 0.5s ease;
      }
      body, button, input, select, textarea {
        font-family: "Rubik", sans-serif;
        line-height: normal;

      }
      body {
        color: white;
        overflow: hidden;
      }
      body.light {
        color: rgba(0,0,0,0.6);
      }
      .hidden {
        display: none;
      }

    </style>
  </head>
  <body class="">
    <img id="albumart" />
    <p id="title"></p>
    <p id="artist"></p>
    <p id="album"></p>
    <p id="quality"></p>
    <ul id="queue">
      <li><span class="title"></span><span class="artist"></span></li>
      <li><span class="title"></span><span class="artist"></span></li>
      <li><span class="title"></span><span class="artist"></span></li>
      <li><span class="title"></span><span class="artist"></span></li>
    </ul>
    <p id="queue-pos"></p>
    <p id="elapsed">0:00</p>
    <svg id="state-play" class="hidden" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-play"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
    <svg id="state-pause" class="hidden" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-pause"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>
    <p id="duration">0:00</p>
    <progress id="progress" value="0" max="1000"></progress>
    <div id="not-playing">
      <!--<img src="/img/notplaying.png">-->
      <img src="/img/falk-white.svg">
    </div>
  </body>
  <script src="color-thief.min.js"></script>
  <script src="event-dispatcher.min.js"></script>
  <script>
    var ColorThief = new ColorThief()
    var State = null
    var Clock = null

    function formatTime(s) {
      function str_pad_left(string,pad,length) {
        return (new Array(length+1).join(pad)+string).slice(-length);
      }
      var hours = Math.floor(s / 3600)
      s = s - hours * 3600
      var minutes = Math.floor(s / 60)
      var seconds = s - minutes * 60
      if (hours > 0) {
        return hours + ':' + str_pad_left(minutes,'0',2) + ':'+str_pad_left(seconds,'0',2)
      } else {}
        return minutes + ':'+str_pad_left(seconds,'0',2)
    }

    function getLightness(rgb){
      var r = rgb[0] / 255
      var g = rgb[1] / 255
      var b = rgb[2] / 255

      var maxColor = Math.max(r,g,b)
      var minColor = Math.min(r,g,b)
      //Calculate L:
      var l = (maxColor + minColor) / 2
      console.log(Math.round(l * 100))
      return Math.round(l * 100)
    }

    function setBackground(el) {
      var result = null
      try {
        result = ColorThief.getPalette(el, 3)
      } catch(err) {
        console.log("couldn't get background")
      }
        if (result !== null) {
        if(getLightness(result[0]) < 60) {
          document.body.classList.remove("light")
        } else {
          document.body.classList.add("light")
        }
        document.body.style.backgroundColor = "rgb(" + result[0] + ")"
        document.getElementById('quality').style.color = "rgb(" + result[0] + ")"
      } else {
        document.body.style.backgroundColor = "#888"
        document.getElementById('quality').style.color = "#888"
        document.body.classList.remove("light")
      }
    }

    function tick() {
      State.elapsed = State.elapsed + 100
      setProgress()
    }

    function setProgress() {
      document.getElementById('progress').value = Math.round(State.elapsed / State.duration * 1000)
      document.getElementById('elapsed').innerText = formatTime(Math.round(State.elapsed / 1000))
    }

    function updateStatus (state) {
      window.clearInterval(Clock)
      State = state;
      console.log(state)
      if (state.title) {
        document.querySelector('#albumart').setAttribute('src', window.location.origin + encodeURI(state.albumart))
        document.getElementById('title').innerText = state.title
        document.getElementById('artist').innerText = state.artist
        document.getElementById('album').innerText = state.album + " (" + state.date + ")"
        document.getElementById('quality').innerText = state.sampleRate / 1000 + "kHz " + state.bits + "bit"
        document.getElementById('duration').innerText = formatTime(State.duration)
        State.elapsed = State.elapsed * 1000
        State.duration = State.duration * 1000
        setProgress()
        if (state.state !== "play") {
          document.getElementById("state-play").classList.add('hidden')
          document.getElementById("state-pause").classList.remove('hidden')
        } else {
          document.getElementById("state-play").classList.remove('hidden')
          document.getElementById("state-pause").classList.add('hidden')
          Clock = window.setInterval(tick, 100)
        }
        document.getElementById('not-playing').classList.add('hide')
      } else {
        // nothing playing
        document.getElementById('not-playing').classList.remove('hide')
      }
      server.send('getQueue')
    }

    function updateQueue (queue) {
      if (State !== null && State !== undefined) {
        let els = document.querySelectorAll('#queue > *')
        let p = State.song

        start = ((p === 0) ? p : p - 1)
        if (start + 4 > queue.length) {
          start = queue.length - 4
          if (start < 0) {
            start = 0
          }
        }
        //if current position is not at the start
        songs = queue.slice(start, start + 4)
        for (i=0; i<4; i++) {
          if (i<queue.length) {
          els[i].querySelector('.title').innerText = songs[i].title
            els[i].querySelector('.artist').innerText = songs[i].artist
            if (songs[i].pos == p) {
              els[i].classList.add('active')
            } else {
              els[i].classList.remove('active')
            }
            els[i].classList.remove('hidden')
          } else {
            els[i].classList.add('hidden')
          }
        }

        document.getElementById('queue-pos').innerText = (p + 1) + "/" + queue.length;
      }
    }

    function start() {
      document.querySelector('#albumart').addEventListener('load', function() {
        setBackground(this);
      })
      initWS(window.location.host, () => {
        server.send('getStatus')
      })
    }
   
    document.addEventListener("DOMContentLoaded", start);
  </script>
</html>